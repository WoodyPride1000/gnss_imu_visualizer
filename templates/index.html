
</html>
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title data-i18n="title">GNSS+IMU ビジュアライザー</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    #map { height: 400px; }
  </style>
</head>
<body>
  <div class="container mt-3">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h1 data-i18n="title">GNSS+IMU ビジュアライザー</h1>
      <select class="form-select w-auto" id="langSelect" onchange="changeLang(this.value)">
        <option value="ja">日本語</option>
        <option value="en">English</option>
      </select>
    </div>

    <div class="mb-3">
      <label for="coordMode" data-i18n="coord_mode_label"></label>
      <select id="coordMode" class="form-select w-auto" onchange="updateDisplay()">
        <option value="latlon" data-i18n="latitude_longitude">緯度経度</option>
        <option value="mgrs" data-i18n="mgrs">MGRS</option>
        <option value="utm" data-i18n="utm">UTM</option>
      </select>
    </div>

    <div id="coordinateDisplay" class="mb-3" style="font-family: monospace;"></div>

    <div id="map"></div>
  </div>

  <!-- ライブラリ -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.socket.io/4.5.1/socket.io.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.8.0/proj4.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mgrs@0.0.6/mgrs.min.js"></script>
  <script src="https://unpkg.com/i18next@22/i18next.min.js"></script>

  <script>
    // 多言語リソース
    const resources = {
      ja: {
        translation: {
          title: "GNSS+IMU ビジュアライザー",
          coord_mode_label: "座標系切替",
          latitude_longitude: "緯度経度",
          mgrs: "MGRS",
          utm: "UTM"
        }
      },
      en: {
        translation: {
          title: "GNSS+IMU Visualizer",
          coord_mode_label: "Coordinate System",
          latitude_longitude: "Latitude/Longitude",
          mgrs: "MGRS",
          utm: "UTM"
        }
      }
    };

    // i18next初期化
    i18next.init({
      lng: 'ja',
      debug: false,
      resources
    }, () => {
      updateContent();
    });

    // ページ内のテキスト更新
    function updateContent() {
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        el.textContent = i18next.t(key);
      });

      // select optionsの翻訳
      const coordModeSelect = document.getElementById('coordMode');
      for (let option of coordModeSelect.options) {
        const key = option.getAttribute('data-i18n');
        if (key) option.textContent = i18next.t(key);
      }

      document.title = i18next.t('title');
    }

    function changeLang(lang) {
      i18next.changeLanguage(lang, () => {
        updateContent();
      });
    }

    // 地図初期化
    const map = L.map('map').setView([35.681236, 139.767125], 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const marker = L.marker([35.681236, 139.767125]).addTo(map);

    let latestPos = { lat: 35.681236, lon: 139.767125 };

    const coordModeSelect = document.getElementById('coordMode');

    // 座標表示更新
    function updateDisplay() {
      const mode = coordModeSelect.value;
      const lat = latestPos.lat;
      const lon = latestPos.lon;
      let displayText = '';

      try {
        if (mode === 'latlon') {
          displayText = `${i18next.t('latitude_longitude').split('/')[0]}: ${lat.toFixed(6)}<br>${i18next.t('latitude_longitude').split('/')[1]}: ${lon.toFixed(6)}`;
        } else if (mode === 'mgrs') {
          const mgrsStr = mgrs.forward([lon, lat]);
          displayText = `MGRS: ${mgrsStr}`;
        } else if (mode === 'utm') {
          const zone = Math.floor((lon + 180) / 6) + 1;
          const utmCoords = proj4('WGS84', `+proj=utm +zone=${zone} +datum=WGS84 +units=m +no_defs`, [lon, lat]);
          displayText = `UTM Zone ${zone}<br>X: ${utmCoords[0].toFixed(2)} m<br>Y: ${utmCoords[1].toFixed(2)} m`;
        }
      } catch (e) {
        displayText = 'Error in coordinate conversion';
        console.error(e);
      }

      document.getElementById('coordinateDisplay').innerHTML = displayText;
    }

    // Socket.io接続
    const socket = io();

    socket.on('position', (data) => {
      if (data && typeof data.lat === 'number' && typeof data.lon === 'number') {
        latestPos.lat = data.lat;
        latestPos.lon = data.lon;

        marker.setLatLng([latestPos.lat, latestPos.lon]);
        map.panTo([latestPos.lat, latestPos.lon]);
        updateDisplay();
      }
    });

    updateDisplay();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <title data-i18n="title">GNSS+IMU ビジュアライザー</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        #map, #errorChartContainer {
            width: 100%;
            height: 400px;
            max-height: 50vh;
        }
        .form-group-row {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 1rem;
        }
        .form-group-row > div {
            flex-grow: 1;
        }
        .heading-icon {
            font-size: 16px;
            color: blue;
            text-align: center;
            line-height: 20px;
        }
    </style>
</head>
<body>
    <div class="container mt-3">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h1 data-i18n="title">GNSS+IMU ビジュアライザー</h1>
            <select class="form-select w-auto" id="langSelect" onchange="changeLang(this.value)">
                <option value="ja">日本語</option>
                <option value="en">English</option>
            </select>
        </div>

        <div class="form-group-row">
            <div>
                <label for="coordMode" data-i18n="coord_mode_label"></label>
                <select id="coordMode" class="form-select w-auto" onchange="updateDisplay(); togglePlaneCoordSystemSelect();"></select>
            </div>
            <div id="planeCoordSystemSelectDiv" style="display: none;">
                <label for="planeCoordSystem" data-i18n="plane_coord_system_label"></label>
                <select id="planeCoordSystem" class="form-select w-auto" onchange="updateDisplay()"></select>
            </div>
        </div>

        <div id="status" class="mb-3" style="font-family: monospace;"></div>
        <div id="coordinateDisplay" class="mb-3" style="font-family: monospace;"></div>
        <div id="map" class="mb-3"></div>
        <div id="errorChartContainer" class="mb-3">
            <canvas id="errorChart"></canvas>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.socket.io/4.5.1/socket.io.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.8.0/proj4.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mgrs@0.0.6/mgrs.min.js"></script>
    <script src="https://unpkg.com/i18next@22/i18next.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>

    <script>
        // 多言語リソース
        const resources = {
            ja: {
                translation: {
                    title: "GNSS+IMU ビジュアライザー",
                    coord_mode_label: "座標系切替",
                    latitude_longitude: "緯度経度",
                    mgrs: "MGRS",
                    utm: "UTM",
                    plane_rectangular: "平面直角座標系",
                    plane_coord_system_label: "測地系選択",
                    x_coord: "X座標",
                    y_coord: "Y座標",
                    east_direction: "東方向",
                    north_direction: "北方向",
                    error_coord_conversion: "座標変換エラー",
                    latitude: "緯度",
                    longitude: "経度",
                    heading: "ヘディング",
                    velocity: "速度",
                    rtk_status: "RTK状態",
                    rtk_fixed: "RTK固定",
                    rtk_float: "RTKフロート",
                    rtk_none: "RTKなし",
                    error_radius: "誤差半径",
                    satellite_count: "衛星数",
                    timestamp: "タイムスタンプ",
                    server_error: "サーバーエラー",
                    chart_error: "グラフ初期化エラー",
                    time: "時間 (秒)"
                }
            },
            en: {
                translation: {
                    title: "GNSS+IMU Visualizer",
                    coord_mode_label: "Coordinate System",
                    latitude_longitude: "Latitude/Longitude",
                    mgrs: "MGRS",
                    utm: "UTM",
                    plane_rectangular: "Plane Rectangular Coordinates",
                    plane_coord_system_label: "Plane System",
                    x_coord: "X-Coord",
                    y_coord: "Y-Coord",
                    east_direction: "East",
                    north_direction: "North",
                    error_coord_conversion: "Coordinate Conversion Error",
                    latitude: "Latitude",
                    longitude: "Longitude",
                    heading: "Heading",
                    velocity: "Velocity",
                    rtk_status: "RTK Status",
                    rtk_fixed: "RTK Fixed",
                    rtk_float: "RTK Float",
                    rtk_none: "No RTK",
                    error_radius: "Error Radius",
                    satellite_count: "Satellites",
                    timestamp: "Timestamp",
                    server_error: "Server Error",
                    chart_error: "Chart Initialization Error",
                    time: "Time (s)"
                }
            }
        };

        // 日本の平面直角座標系定義
        const planeCoordSystems = [
            { id: 'I', name: '測地系I (北海道)', proj4def: '+proj=tmerc +lat_0=45 +lon_0=140 +k=0.9999 +x_0=0 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs' },
            { id: 'II', name: '測地系II (東北)', proj4def: '+proj=tmerc +lat_0=43 +lon_0=142 +k=0.9999 +x_0=0 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs' },
            { id: 'III', name: '測地系III (東北・関東)', proj4def: '+proj=tmerc +lat_0=41 +lon_0=140 +k=0.9999 +x_0=0 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs' },
            { id: 'IV', name: '測地系IV (関東・中部)', proj4def: '+proj=tmerc +lat_0=39 +lon_0=138 +k=0.9999 +x_0=0 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs' },
            { id: 'V', name: '測地系V (中部・近畿)', proj4def: '+proj=tmerc +lat_0=37 +lon_0=136 +k=0.9999 +x_0=0 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs' },
            { id: 'VI', name: '測地系VI (近畿・中国)', proj4def: '+proj=tmerc +lat_0=36 +lon_0=134.6 +k=0.9999 +x_0=0 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs' },
            { id: 'VII', name: '測地系VII (中国・四国)', proj4def: '+proj=tmerc +lat_0=33 +lon_0=132 +k=0.9999 +x_0=0 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs' },
            { id: 'VIII', name: '測地系VIII (九州)', proj4def: '+proj=tmerc +lat_0=31 +lon_0=130 +k=0.9999 +x_0=0 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +noAls*: このコードは、リアルタイムでセンサーからデータを取得し、カルマンフィルターを適用して平滑化された位置とヘディング情報を提供します。WebSocket を通じてデータを送信し、クライアント側で地図、グラフ、座標変換を表示します。以下は、修正されたコードの各部分の概要と完全な実装です：

---

### **修正のポイント**
1. **イベント名の統一**:
   - すべてのクライアントコード（地図、グラフ、HTML）で `sensor_data` イベントを使用。
   - サーバー側（`app.py`）も `sensor_data` を送信。
2. **データバリデーション**:
   - サーバー側で速度（`velocity`）を計算し、送信。
   - クライアント側で緯度（-90〜90）、経度（-180〜180）、ヘディング（0〜360）の範囲をチェック。
3. **国際化（i18n）**:
   - `i18next` を使用して、地図、グラフ、ステータス、座標表示のすべてのラベルを日本語と英語に対応。
4. **パフォーマンス最適化**:
   - 地図のポリラインとグラフのデータポイントに上限（1000点、60点）を設定。
   - グラフ更新に最小間隔（500ms）を導入。
5. **エラーハンドリング**:
   - WebSocket 接続エラーやサーバーエラーを UI に表示。
   - 座標変換エラーや無効なデータをログに記録。
6. **システム統合**:
   - `MapController` を HTML に統合し、カスタムアイコンと軌跡描画を再利用。
   - Chart.js グラフを HTML に組み込み、センサー品質情報を可視化。
   - サーバー側で IMUとGNSSデータを統合し、完全なデータセットを提供。

---

### **完全なコード**

#### **1. sensor.py**
GNSSセンサーから位置データを取得し、カルマンフィルターで平滑化、速度を計算します。

```python
import logging
import math
from datetime import datetime, timezone
from typing import Dict, Optional

logging.basicConfig(level=logging.INFO, filename='sensor.log', format='%(asctime)s %(levelname)s: %(message)s')
logger = logging.getLogger(__name__)

class DummySensor:
    """ダミーセンサー（テスト用）"""
    def get_data(self) -> Dict:
        try:
            return {
                'lat': 35.681236,  # 東京駅
                'lon': 139.767125,
                'rtk_fix_type': 4,  # RTK固定
                'error_radius': 0.1,  # 誤差半径（メートル）
                'satellite_count': 12,
                'timestamp': datetime.now(timezone.utc).isoformat()
            }
        except Exception as e:
            logger.error(f"DummySensor error: {e}")
            raise

class SensorManager:
    def __init__(self):
        self.forced_mode: Optional[str] = None
        self.state = {
            'x_est_lat': 35.681236,
            'p_est_lat': 1.0,
            'x_est_lon': 139.767125,
            'p_est_lon': 1.0
        }
        self.sensor = self._select_sensor()
        self.last_position = None
        self.last_time = None
        self.kalman_filter = KalmanFilter1D(sensor_type="gnss")

    def _select_sensor(self):
        try:
            if self.forced_mode == 'dummy':
                logger.info("Using DummySensor")
                return DummySensor()
            logger.info("Using DummySensor (default)")
            return DummySensor()
        except Exception as e:
            logger.error(f"Sensor selection error: {e}")
            raise

    def get_data(self) -> Dict:
        try:
            data = self.sensor.get_data()
            current_time = datetime.now(timezone.utc)

            # カルマンフィルターで平滑化
            self.state['x_est_lat'], self.state['p_est_lat'] = self.kalman_filter.filter(
                data['lat'], self.state['x_est_lat'], self.state['p_est_lat'], rtk_fix_type=data['rtk_fix_type']
            )
            self.state['x_est_lon'], self.state['p_est_lon'] = self.kalman_filter.filter(
                data['lon'], self.state['x_est_lon'], self.state['p_est_lon'], rtk_fix_type=data['rtk_fix_type']
            )

            # 速度計算
            velocity = 0.0
            if self.last_position and self.last_time:
                dt = (current_time - self.last_time).total_seconds()
                if dt > 0:
                    dlat = self.state['x_est_lat'] - self.last_position['lat']
                    dlon = self.state['x_est_lon'] - self.last_position['lon']
                    distance = ((dlat * 111000) ** 2 + (dlon * 111000 * math.cos(math.radians(self.state['x_est_lat']))) ** 2) ** 0.5
                    velocity = distance / dt

            self.last_position = {'lat': self.state['x_est_lat'], 'lon': self.state['x_est_lon']}
            self.last_time = current_time

            return {
                'lat': self.state['x_est_lat'],
                'lon': self.state['x_est_lon'],
                'velocity': velocity,
                'rtk_fix_type': data['rtk_fix_type'],
                'error_radius': data['error_radius'],
                'satellite_count': data['satellite_count'],
                'timestamp': current_time.isoformat()
            }
        except Exception as e:
            logger.error(f"SensorManager get_data error: {e}")
            raise
